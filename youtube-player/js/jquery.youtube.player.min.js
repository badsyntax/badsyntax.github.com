/*
 * jquery.youtube.min.js v0.1a1 - a jquery youtube player
 * Copyright (c) 2010 Richard Willis
 * MIT license	: http://www.opensource.org/licenses/mit-license.php
 * Project	: http://github.com/badsyntax/jquery-youtube-player
 * Contact	: willis.rh@gmail.com | badsyntax.co.uk
 */
(function(e,h,k,i){function m(a,b,c){var d=this;this._pluginName=c;this.element=e(a).addClass("ui-widget");this.options=e.extend({width:425,height:356,swfobject:h.swfobject,playlist:{},showPlaylist:1,showTime:1,showTitleOverlay:1,videoThumbs:0,randomStart:0,autoStart:0,repeat:0,shuffle:0,updateHash:0,highDef:0,playlistHeight:5,playlistBuilder:null,playlistBuilderClickHandler:null,playlistSpeed:550,toolbarAppendTo:null,playlistAppendTo:null,timeAppendTo:null,videoParams:{allowfullscreen:"true",allowScriptAccess:"always", wmode:"transparent"},toolbarButtons:{},toolbar:"play,prev,next,shuffle,repeat,mute,playlistToggle"},b);this._states={unstarted:-1,ended:0,play:1,paused:2,buffering:3,cued:5};this.buttons=e.extend({},e.youtubePlayerButtons,this.options.toolbarButtons);this.elements={player:this.element,playerVideo:this.element.find(".youtube-player-video"),playerObject:this.element.find(".youtube-player-object")};this.elements.playerObjectClone=this.elements.playerObject.clone();this.keys={video:0};this._uniqueId(this.elements.playerObject[0], "youtube-player-");this.loadPlaylist(null,null,null,function(){d._createElements()._bindPlayerEventHandlers()._bindYoutubeEventHandlers()._initRouter()})}e.fn.player=function(a){var b=arguments,c=i;this.each(function(){var d=e.data(this,"jquery-youtube-player");if(d&&d[a]){c=d[a].apply(d,Array.prototype.slice.call(b,1));c=a=="plugin"?c:i}else if(!d&&(typeof a==="object"||!a))e.data(this,"jquery-youtube-player",new m(this,a,"jquery-youtube-player"))});return c||this};m.prototype={_activeStates:[], timer:{},router:{},videoIds:[],_initRouter:function(){var a=this,b=h.location.hash.replace(/.*?#\//,"");this.router={hash:b,actions:/\//.test(b)?b.split("/"):["v"],updateHash:function(){if(a.options.updateHash)h.location.hash="/"+a.router.actions[0]+"/"+a.options.playlist.videos[a.keys.video].id}};switch(this.router.actions[0]){case "v":this.keys.video=this.router.actions[1]?e.inArray(this.router.actions[1],this.videoIds):this.keys.video;break;case "p":this.keys.video=e.inArray(this.router.actions[1], this.videoIds);this.keys.play=1}return this},_uniqueId:function(a,b){b=b||"random-";var c;do c=b+Math.floor(Math.random()*101).toString();while(k.getElementById(c));if(a)a.id=c;return c},_trigger:function(a,b,c){var d=typeof b;c=c||[];if(d==="string"&&this.options[b]&&e.isFunction(this.options[b]))return this.options[b].apply(a,c);else d==="function"&&b.apply(a,c)},_buttonData:function(a,b,c){if(this.buttons[a]&&this.buttons[a].element)return!c?this.buttons[a].element.data(b):this.buttons[a].element.data(b, c)},_bindYoutubeEventHandlers:function(){var a=this;this.youtubePlayerEvents={ready:function(){a.youtubePlayer=a.elements.playerVideo.find("object:first").get(0);try{a.youtubePlayer.addEventListener("onStateChange","_youtubeevents");a.youtubePlayer.addEventListener("onError","_youtubeevents")}catch(b){a._triger(a,"onError",[b])}var c=a._buttonData("fullscreen","time")||0;a.loadVideo(false,true);c&&a._state("play")&&a.playVideo(false,c);a.elements.toolbar.container.animate({opacity:1},400,function(){a._trigger(a, "onReady",arguments)});a._showPlaylist();a.keys.play&&a.playVideo()},videoPlay:function(){a._updatePlaylist();a.router.updateHash();a._addState("play");a.elements.toolbar.updateStates();a._updateInfo(320);a._updateTime();a._trigger(this,"onVideoPlay",arguments)},videoPaused:function(){a._trigger(this,"onVideoPaused",arguments)},videoEnded:function(){a.buttons.play.element.trigger("off");a.options.repeat&&a.nextVideo()},error:function(b){switch(b){case 100:msg="This video has been removed from Youtube."; break;case 101:case 150:msg="This video does not allow playback outside of Youtube.";break;default:msg="Unknown error"}a._trigger(this,"onError",[msg])===i&&alert("There was an error loading this video. "+msg)},videoBuffer:function(){a._trigger(this,"onBuffer",arguments)}};h.onYouTubePlayerReady=function(){a._youtubeEventHandler(9)};h._youtubeevents=function(b){a._youtubeEventHandler(b)};return this},_bindPlayerEventHandlers:function(){var a=this;this.elements.playerVideo.one("mouseenter.player", function(){a._updateInfo()}).one("mouseleave.player",function(){a._hideInfo()});return this},_youtubeEventHandler:function(a){this._removeStates([-1,0,1,2,3,5,100,101,150,9]);this._addState(a,true);switch(a){case 0:this.youtubePlayerEvents.videoEnded();break;case 1:this.youtubePlayerEvents.videoPlay();break;case 2:this.youtubePlayerEvents.videoPaused();break;case 3:this.youtubePlayerEvents.videoBuffer();break;case 100:case 101:case 150:this.youtubePlayerEvents.error(a);break;case 9:this.youtubePlayerEvents.ready()}this._trigger(this, "onYoutubeStateChange",[a])},_removeStates:function(a){var b=[];e.each(this._activeStates,function(c,d){e.inArray(d,a)===-1&&e.inArray(d,b)===-1&&b.push(d)});this._activeStates=b},_removeState:function(a){this._removeStates([this._states[a]])},_state:function(a){a=this._states[a];return e.inArray(a,this._activeStates)!==-1?true:false},_addState:function(a,b){if(b)e.inArray(a,this._activeStates)===-1&&this._activeStates.push(a);else this._states[a]&&e.inArray(this._states[a],this._activeStates)=== -1&&this._activeStates.push(this._states[a])},_getPlaylistData:function(a,b){var c=this,d=this.options.playlist;if(d.user||d.playlist){var g=function(l){if(l){c.options.playlist={title:l.feed.title.$t,id:d,videos:[]};e.each(l.feed.entry,function(o,n){c.options.playlist.videos.push({id:n.link[0].href.replace(/^[^v]+v.(.{11}).*/,"$1"),title:n.title.$t})});c.elements.playerObject.fadeOut(180,function(){a.call(c)})}else b.call(c)},f=d.user?"http://gdata.youtube.com/feeds/api/videos":"http://gdata.youtube.com/feeds/api/playlists/"+ d.playlist;f+="?callback=?";this._trigger(this,"onBeforePlaylistLoaded",[d]);var j={alt:"json",format:"5"};if(d.user)j.author=d.user;e.ajax({type:"GET",url:f,data:j,dataType:"json",error:function(){c._trigger(c,"onAfterPlaylistLoaded",[d]);c._trigger(c,b)},success:function(){c._trigger(c,"onAfterPlaylistLoaded",[d]);c._trigger(c,g,arguments)}})}else{c._trigger(c,"onAfterPlaylistLoaded",[d]);c._trigger(c,a)}},_updatePlaylist:function(){var a=this;this.elements.playlist&&this.elements.playlist.find("li").removeClass("ui-state-active").each(function(b){if(a.options.playlist.videos[a.keys.video].id== e(this).data("video").id){var c=e(this).addClass("ui-state-active").outerHeight();a.options.videoThumbs||a.elements.playlist.scrollTop(b*c-Math.floor(a.options.playlistHeight/2)*c);return false}})},_showPlaylist:function(a){(a=a===i?true:a)&&this.elements.playlistContainer.show();this.elements.playlist.height();var b=this.elements.playlist.css("height","auto").height(),c=this.elements.playlist.find("li:first").outerHeight()*this.options.playlistHeight;b=c<b?c:b;a&&this.elements.playlistContainer.hide(); if(this.elements.playlist.children().length){if(b){this.elements.playlist.height(b);if(this.options.showPlaylist||a)this.elements.playlistContainer.animate({height:"show",opacity:"show"},this.options.playlistSpeed)}}else this.elements.playlistContainer.hide()},option:function(a,b){if(b)this.options[a]=b;else return this.options[a]},loadVideo:function(a,b){function c(g){b?d.cueVideo(g):d.youtubePlayer.loadVideoById(g,0);d.router.updateHash();d._trigger(d,"onVideoLoad",[g])}var d=this;this._hideInfo(); if(a&&a.id){a={id:a.id,title:a.title};this.videoIds=b?this.videoIds:[];if(b)this.options.playlist.videos.push(a);else this.options.playlist.videos=a.title?[a]:[];this._addVideosToPlaylist(b);this._showPlaylist(false);!b&&c(a.id)}else c(this.options.playlist.videos[this.keys.video].id)},loadPlaylist:function(a,b,c,d){if(a)this.options.playlist=a;this._getPlaylistData(function(){this.keys.video=this.options.randomStart?this.randomVideo():0;if(this.youtubePlayer){this._addVideosToPlaylist();b?this.loadVideo(): this.cueVideo();this._showPlaylist(c)}this._trigger(this,d)},function(){this.elements.playerObject.html("There was an error loading the playlist.");this._trigger(this,"onError",["There was an error loading the playlist."])})},pauseVideo:function(){this.youtubePlayer.pauseVideo()},shufflePlaylist:function(){this.randomVideo();this.playVideo()},muteVideo:function(){this._state("mute")?this.youtubePlayer.unMute():this.youtubePlayer.mute()},repeat:function(){this.options.repeat=1},playVideo:function(){this.youtubePlayer.playVideo()}, cueVideo:function(a,b){a=a||this.options.playlist.videos[this.keys.video].id;this._trigger(this,"onVideoCue",[a]);return this.youtubePlayer.cueVideoById(a,b||0)},randomVideo:function(){this.keys.video=Math.floor(Math.random()*this.options.playlist.videos.length);return this.keys.video},prevVideo:function(){if(this.keys.video>0){this.keys.video--;this.loadVideo();this.playVideo()}},nextVideo:function(){if(this.keys.video<this.options.playlist.videos.length-1){if(this.options.shuffle)this.randomVideo(); else this.keys.video++;this.loadVideo();this.playVideo()}},playlistToggle:function(){this.elements.playlistContainer.find("li").length&&this.elements.playlistContainer.animate({height:"toggle",opacity:"toggle"},this.options.playlistSpeed)},fullscreen:function(a){var b=this;this._hideInfo();a.element.one("open.player",function(){e.data(this,"height",b.elements.playerVideo.height());e.data(this,"time",b.youtubePlayer.getCurrentTime());e("body").css("overflow","hidden");b.elements.playerVideo.css({height:"100%", width:"100%",position:"absolute",top:0,left:0,zIndex:9999}).appendTo(k.body)}).one("close.player",function(){e.data(this,"time",b.youtubePlayer.getCurrentTime());e("body").css("overflow","auto");b.elements.playerVideo.height(e.data(this,"height")).css("position","static").prependTo(b.elements.player);b._removeState("fullsreen")}).trigger("open.player");b.elements.playerVideo.one("dblclick",function(){a.element.trigger("close.player")});e(k).one("keypress",function(c){c.keyCode==27&&a.element.trigger("close.player")})}, plugin:function(){return this},state:function(){var a=this,b=[];e.each(this._activeStates,function(c,d){e.each(a._states,function(g,f){d===f&&b.push(g)})});return b},videos:function(){return this.options.playlist.videos},videoIndex:function(){return this.keys.video},_updateInfo:function(a,b){if(!(!this.options.showTitleOverlay||this._state("fullscreen"))){b=b||(this.options.playlist.videos[this.keys.video]?this.options.playlist.videos[this.keys.video].title:"");var c=this;if((this._state("play")|| this._state("pause"))&&this.elements.infobar.css("opacity")<1&&b){clearTimeout(this.timer._hideInfo);this.timer.showInfo=setTimeout(function(){c.elements.infobar.stop(true,true).css({opacity:0}).html(b).unbind("click").click(function(){c.buttons.play.element.trigger("off");h.open(c.youtubePlayer.getVideoUrl())}).animate({opacity:1},180,function(){c.timer._hideInfo=setTimeout(function(){c._hideInfo()},6E3)})},a||0)}}},_hideInfo:function(){clearTimeout(this.timer._hideInfo);clearTimeout(this.timer.showInfo); this.elements.infobar.stop(true,true).animate({opacity:0},120)},_updateTime:function(){function a(d){d=Number(d);var g=Math.floor(d/3600),f=Math.floor(d%3600/60);d=Math.floor(d%3600%60);return(g>0?g+":":"")+(f>0?(g>0&&f<10?"0":"")+f+":":"0:")+(d<10?"0":"")+d}if(this.options.showTime){var b=this,c=this.youtubePlayer.getDuration();this.elements.toolbar.timeDuration.html(" / "+a(c));this.elements.toolbar.time.fadeIn();this.timeInterval=setInterval(function(){if(b.youtubePlayer.getCurrentTime){var d= b.youtubePlayer.getCurrentTime();b.elements.toolbar.timeCurrent.html(a(d))}else clearInterval(b.timeInterval)},100)}},_createElements:function(){if(this.options.swfobject.getFlashPlayerVersion().major>=8){this._createPlayer()._createToolbar()._createInfobar();this._createPlaylist()}return this},_createPlayer:function(){this.elements.player.width(parseInt(this.options.width));this.elements.playerVideo.height(parseInt(this.options.height));this.options.swfobject.embedSWF("http://www.youtube.com/apiplayer?enablejsapi=1&version=3&playerapiid=youtube&hd="+ this.options.highDef+"&showinfo=0",this.elements.playerObject[0].id,"100%","100%","8",null,null,this.options.videoParams);return this},_createToolbar:function(){function a(c){var d=false;e.each(b._states,function(g){if(c==g){d=true;return false}});d||(b._states[c]=c);return d}var b=this;this.elements.toolbar={container:e('<ul class="youtube-player-toolbar ui-widget ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">').css("opacity",0),updateStates:function(){e.each(b.options.toolbar.split(","), function(c,d){var g=b.buttons[d];if(!g)return true;g.element.removeClass("ui-state-active");b._state(d)&&g.toggle&&g.element.addClass("ui-state-active");b._state(d)&&g.toggleButton&&g.element.trigger("on")})}};e.each(this.options.toolbar.split(","),function(c,d){var g=b.buttons[d];if(!g||!g.text)return true;a(d);b.buttons[d].element=e('<li class="ui-state-default ui-corner-all"></span>').append('<span class="ui-icon '+g.icon+'"></span>').attr("title",g.text).data("button",g).bind("mouseenter mouseleave", function(){e(this).toggleClass("ui-state-hover")}).bind("off",function(){var f=e(this).data("button");e(this).data("toggle",1);b._removeState(d);f.element.find(".ui-icon").removeClass(f.toggleButton.icon).addClass(f.icon);f.element.attr("title",f.text);b._trigger(b,f.toggleButton.action,[f])}).bind("on",function(){var f=e(this).data("button");e(this).data("toggle",0);b._addState(d);f.element.find(".ui-icon").removeClass(f.icon).addClass(f.toggleButton.icon);f.element.attr("title",f.toggleButton.text); b._trigger(b,f.action,[f])}).bind("toggle",function(){var f=e(this).data("toggle");f||f==i?e(this).trigger("on"):e(this).trigger("off")}).click(function(){var f=e(this).data("button"),j=b._state(d);if(f.toggleButton)e(this).trigger("toggle");else{b._trigger(b,f.action,[f]);!f.toggle||f.toggle&&j?b._removeState(d):b._addState(d);b.elements.toolbar.updateStates()}}).appendTo(b.elements.toolbar.container)});this._createTimeArea();this.options.toolbarAppendTo?this.elements.toolbar.container.appendTo(this.options.toolbarAppendTo): this.elements.playerVideo.after(this.elements.toolbar.container);return this},_createTimeArea:function(){this.elements.toolbar.time=this.options.timeAppendTo?e("<span />").appendTo(this.options.timeAppendTo):e('<li class="youtube-player-time">').appendTo(this.elements.toolbar.container);this.elements.toolbar.timeCurrent=e("<span>").html("0:00").appendTo(this.elements.toolbar.time);this.elements.toolbar.timeDuration=e("<span>").appendTo(this.elements.toolbar.time)},_createInfobar:function(){this.elements.infobar= e("<div>").addClass("youtube-player-infobar ui-widget-content").css("opacity",0).bind("mouseenter mouseleave",function(){e(this).toggleClass("ui-state-hover")});this.elements.playerVideo.prepend(this.elements.infobar);return this},_createPlaylist:function(){function a(){var d=e(this).data("video");if(d){b.keys.video=e.inArray(d.id,b.videoIds);b._removeState("play");b._updatePlaylist();b.loadVideo();b.playVideo()}}var b=this;this._buildPlaylist=function(){b.elements.playlistContainer=e("<div>").addClass("youtube-player-playlist-container ui-widget-content ui-corner-all"); b.elements.playlist=e("<ol>").addClass("youtube-player-playlist ui-helper-reset")};this._addVideosToPlaylist=function(d){var g=d?[b.options.playlist.videos[b.options.playlist.videos.length-1]]:b.options.playlist.videos;d||b.elements.playlist.empty();b.videoIds=[];e.each(g,function(){b.videoIds.push(this.id);e("<li>").data("video",this).append(b.options.videoThumbs?'<img alt="'+this.title+'" title="'+this.title+'" src="http://img.youtube.com/vi/'+this.id+'/2.jpg" />':this.title).addClass("ui-state-default").addClass(b.options.videoThumbs? "youtube-player-thumb":"").bind("mouseenter mouseleave",function(){e(this).toggleClass("ui-state-hover")}).click(function(){b._trigger(this,a,arguments)}).appendTo(b.elements.playlist)})};if(this.options.playlistBuilder&&e.isFunction(this.options.playlistBuilder)){e.each(this.options.playlist.videos,function(){b.videoIds.push(this.id)});var c=this.options.playlistBuilder.call(this,this.options.playlist.videos);c.items.click(function(){b._trigger(this,a,arguments);b._trigger(b,"playlistBuilderClickHandler", arguments)});this.elements.playlistContainer=c.container}else{this._buildPlaylist();this._addVideosToPlaylist();this.elements.playlistContainer.append(this.elements.playlist);this.options.playlistAppendTo?this.elements.playlistContainer.appendTo(this.options.playlistAppendTo):this.elements.toolbar.container.after(this.elements.playlistContainer)}return this},destroy:function(){clearInterval(this.timeInterval);this.element.removeClass("ui-widget").removeAttr("style");this.elements.playerVideo.removeAttr("style"); this.elements.infobar.remove();this.elements.playlistContainer.remove();this.elements.toolbar.container.remove();this.options.swfobject.removeSWF(this.elements.playerObject[0].id);this.elements.playerObjectClone.appendTo(this.elements.playerVideo);e.removeData(this.element[0],this._pluginName)}};e.youtubePlayerButtons={play:{text:"Play",icon:"ui-icon-play",toggleButton:{text:"Pause",icon:"ui-icon-pause",action:function(){this.pauseVideo()}},action:function(){this.playVideo()}},prev:{text:"Prev",icon:"ui-icon-seek-prev", action:function(){this.prevVideo()}},next:{text:"Next",icon:"ui-icon-seek-next",action:function(){this.nextVideo()}},shuffle:{text:"Shuffle/Random",icon:"ui-icon-shuffle",toggle:1,action:function(){this.shufflePlaylist()}},repeat:{text:"Repeat playlist",icon:"ui-icon-refresh",toggle:1,action:function(){this.repeat()}},mute:{text:"Mute",icon:"ui-icon-volume-on",toggle:1,action:function(a){this.muteVideo(a)}},fullscreen:{text:"Full screen",icon:"ui-icon-arrow-4-diag",action:function(a){this.fullscreen(a)}}, playlistToggle:{text:"Toggle playlist",icon:"ui-icon-script",action:function(){this.playlistToggle()}}}})(this.jQuery,this,document);
