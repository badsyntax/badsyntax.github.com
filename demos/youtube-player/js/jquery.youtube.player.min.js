/*
 * jquery youtube player
 * Copyright (c) 2010 Richard Willis
 * http://github.com/badsyntax/jquery-youtube-player
 * http://badyntax.co.uk
 */
(function(c,f){function h(b,d){var a=this;this.options=c.extend({width:425,height:356,swfobject:f.swfobject,playlist:[],playlistProxy:"playlist_proxy.php",showPlaylist:1,repeat:0,randomStart:1,autoStart:0,shuffle:0,updateHash:0,tracklistHeight:5,videoParams:{allowScriptAccess:"always"},toolbar:{buttons:{play:{text:"Play",icon:"ui-icon-play",toggleButton:"pause"},pause:{text:"Pause",icon:"ui-icon-pause",toggleButton:"play"},prev:{text:"Prev",icon:"ui-icon-seek-prev"},next:{text:"Next",icon:"ui-icon-seek-next"}, shuffle:{text:"Shuffle/Random",icon:"ui-icon-shuffle",toggle:1},repeat:{text:"Repeat playlist",icon:"ui-icon-refresh",toggle:1},mute:{text:"Mute",icon:"ui-icon-volume-on",toggle:1},playlist:{text:"Toggle playlist",icon:"ui-icon-script"},playlists:{text:"Toggle playlists",icon:"ui-icon-video",toggle:1,disabled:1}}},onready:function(){}},d);this.element=c(b);this.events={play:function(){a.elements.loader.show();a.loadVideo();a.youtube.playVideo()},pause:function(){a.youtube.pauseVideo()},prev:function(){if(a.keys.video> 0){a.keys.video--;a.elements.toolbar.buttons.play.element.data("state",0);a.events.play()}},next:function(){if(a.keys.video<a.options.playlist.videos.length-1){if(a.options.shuffle)a.randomVideo();else a.keys.video++;a.elements.toolbar.buttons.play.element.data("state",0);a.events.play()}},shuffle:function(){a.randomVideo();a.events.play()},repeat:function(){a.options.repeat=1},mute:function(e){e.element.data("state")?a.youtube.mute():a.youtube.unMute()},playlist:function(){a.elements.playlistContainer.animate({height:"toggle", opacity:"toggle"},550)},updatePlaylist:function(){a.elements.playlist.find("li").removeClass("ui-state-active").each(function(e){if(a.options.playlist.videos[a.keys.video].id==c(this).data("video").id){var g=c(this).addClass("ui-state-active").outerHeight();a.elements.scrollbar.pos=e*g-Math.floor(a.options.tracklistHeight/2)*g;a.elements.playlistScroller.scrollTop(a.elements.scrollbar.pos);return false}})}};this.events.youtube={ready:function(){a.youtube=a.elements.player.find("object:first").get(0); a.youtube.addEventListener("onStateChange","_youtubeevents");a.youtube.addEventListener("onError","_youtubeevents");a.cueVideo();a.elements.toolbar.$container.fadeIn(800,function(){c.isFunction(a.options.onready)&&a.options.onready()});a.elements.playlistContainer.show();var e=a.elements.playlist.find("li:first").outerHeight();a.elements.playlistContainer.hide();a.elements.playlistScroller.height(e*a.options.tracklistHeight);a.options.showPlaylist&&a.elements.playlistContainer.animate({height:"toggle", opacity:"toggle"},550);a.keys.play&&a.events.play()},videoPlay:function(){a.elements.loader.hide();if(!a.elements.toolbar.buttons.play.element.data("state")){a.events.updatePlaylist();a.router.updateHash();a.elements.toolbar.buttons.play.element.data("state",1);a.elements.toolbar.updateStates();a.elements.$infobar.css({opacity:0});a.updateInfo(320)}},videoEnded:function(){a.options.repeat&&a.events.next()},error:function(e){a.elements.loader.hide();switch(e){case 100:msg="This video has been removed from Youtube."; break;case 101:case 150:msg="This video does not allow playback outside of Youtube.";break;default:msg=""}alert("Sorry, there was an error loading this video. "+msg)},videoBuffer:function(){}};this.events.scrollbar={up:function(){a.elements.scrollbar.pos=a.elements.scrollbar.pos>a.elements.playlist.find("li:first").height()?a.elements.scrollbar.pos-a.elements.playlist.find("li:first").height():0;a.elements.playlistScroller.scrollTop(a.elements.scrollbar.pos)},down:function(){a.elements.scrollbar.pos= a.elements.scrollbar.pos<a.elements.playlist.outerHeight()-a.elements.playlistScroller.outerHeight()?a.elements.scrollbar.pos+a.elements.playlist.find("li:first").height():a.elements.scrollbar.pos;a.elements.playlistScroller.scrollTop(a.elements.scrollbar.pos)}};this.init()}c.fn.player=function(b){return this.each(function(){c(this).data("player",new h(this,b))})};h.prototype={state:-1,timer:{},router:{},videoIds:[],elements:{},init:function(){this.element.addClass("ui-widget");this.elements.player= this.element;this.elements.playerVideo=c("#player-video");this.elements.playerObject=c("#player-object");this.keys={video:0};this.youtube=this.elements.playerObject.get(0);this.getPlaylistData(function(){this.keys.video=this.options.randomStart?this.randomVideo():0;this.createElements().bindPlayerEvents().bindYtEvents().initRouter()},function(){this.elements.playerObject.html("There was an error loading the playlist.").removeClass("playlist-loading")})},getPlaylistData:function(b,d){var a=this,e= this.options.playlist;if(String===e.constructor||Number===e.constructor){a.elements.playerObject.html("loading playlist..").addClass("playlist-loading");c.ajax({type:"GET",url:"http://gdata.youtube.com/feeds/api/playlists/"+e,data:{alt:"json"},dataType:"json",error:function(){d.call(a)},success:function(g){if(g){a.options.playlist={title:g.feed.title.$t,id:e,videos:[]};c.each(g.feed.entry,function(j,i){a.options.playlist.videos.push({id:i.link[0].href.replace(/^[^v]+v.(.{11}).*/,"$1"),title:i.title.$t})}); a.elements.playerObject.fadeOut(180,function(){b.call(a)})}else d.call(a)}})}else b.call(a)},initRouter:function(){var b=this,d=f.location.hash.replace(/.*?#\//,"");this.router={hash:d,actions:/\//.test(d)?d.split("/"):["v"],updateHash:function(){if(b.options.updateHash)f.location.hash="/"+b.router.actions[0]+"/"+b.options.playlist.videos[b.keys.video].id}};switch(this.router.actions[0]){case "v":this.keys.video=this.router.actions[1]?c.inArray(this.router.actions[1],this.videoIds):this.keys.video; break;case "p":this.keys.video=c.inArray(this.router.actions[1],this.videoIds);this.keys.play=1}},bindYtEvents:function(){var b=this;f.onYouTubePlayerReady=function(){b.youtubeEventHandler(9)};f._youtubeevents=function(d){b.youtubeEventHandler(d)};return this},bindPlayerEvents:function(){var b=this;this.elements.playerVideo.bind("mouseenter",function(){b.updateInfo()}).bind("mouseleave",function(){b.hideInfo()});return this},youtubeEventHandler:function(b){if(b!=this.state)switch(this.state=b){case 0:this.events.youtube.videoEnded(); break;case 1:this.events.youtube.videoPlay();break;case 3:this.events.youtube.videoBuffer();break;case 100:case 101:case 150:this.events.youtube.error(b);break;case 9:this.events.youtube.ready()}},updateInfo:function(b,d){var a=this;this.elements.loader.hide();if((this.elements.toolbar.buttons.play.element.data("state")||this.elements.toolbar.buttons.pause.element.data("state"))&&this.elements.$infobar.css("opacity")<1){clearTimeout(this.timer.hideInfo);this.timer.showInfo=setTimeout(function(){a.elements.$infobar.stop(true, true).css({opacity:0}).html(d||a.options.playlist.videos[a.keys.video].title).unbind("click").click(function(){f.open(a.youtube.getVideoUrl())}).animate({opacity:1},180,function(){a.timer.hideInfo=setTimeout(function(){a.hideInfo()},6E3)})},b||0)}},hideInfo:function(){clearTimeout(this.timer.hideInfo);clearTimeout(this.timer.showInfo);this.elements.$infobar.stop(true,true).animate({opacity:0},120)},cueVideo:function(b){this.youtube.cueVideoById(b||this.options.playlist.videos[this.keys.video].id, 0)},loadVideo:function(b){this.elements.$infobar.stop().css({opacity:0});this.youtube.loadVideoById(b||this.options.playlist.videos[this.keys.video].id,0);this.router.updateHash()},randomVideo:function(){this.keys.video=Math.floor(Math.random()*this.options.playlist.videos.length);return this.keys.video},createElements:function(){return this.createPlayer().createToolbar().createInfobar().createTracklist()},createPlayer:function(){this.elements.player.width(this.options.width);this.elements.playerVideo.height(this.options.height); this.options.swfobject&&this.options.swfobject.embedSWF("http://www.youtube.com/apiplayer?enablejsapi=1&version=3&playerapiid=youtube&hd=1&showinfo=0",this.youtube.id,this.options.width,this.options.height,"8",null,null,this.options.videoParams);return this},createToolbar:function(){var b=this;this.elements.toolbar=c.extend({$container:c('<ul id="player-toolbar" class="ui-widget ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">'),updateStates:function(){c.each(b.elements.toolbar.buttons, function(){this.element.removeClass("ui-state-active");this.element.data("state")&&(this.toggle||this.toggleButton&&b.elements.toolbar.buttons[this.toggleButton])&&this.element.addClass("ui-state-active")})}},this.options.toolbar||{});c.each(this.elements.toolbar.buttons,function(d){if(this.disabled){delete b.elements.toolbar.buttons[d];return true}var a=this;this.element=c('<li class="ui-state-default ui-corner-all">').append('<span class="ui-icon '+this.icon+'">').attr("title",this.text).data("button", d).bind("mouseenter",function(){c(this).toggleClass("ui-state-hover")}).bind("mouseleave",function(){c(this).toggleClass("ui-state-hover")}).click(function(){var e=c(this).data("state",c(this).data("state")&&a.toggle?0:1).data("button");a.toggleButton&&b.elements.toolbar.buttons[a.toggleButton].element.data("state",0);b.elements.toolbar.updateStates();b.events[e](a)}).appendTo(b.elements.toolbar.$container)});this.elements.playerVideo.after(this.elements.toolbar.$container);this.elements.loader=c("<span>").addClass("player-loader"); this.elements.toolbar.$container.after(this.elements.loader);return this},createInfobar:function(){this.elements.$infobar=c('<div id="player-infobar">').addClass("ui-widget-content ui-corner-all").css("opacity",0);this.elements.playerVideo.prepend(this.elements.$infobar);return this},createTracklist:function(){var b=this;this.elements.playlistScroller=this.elements.playlistScroller||c('<div id="player-playlist-scroller">');c.fn.mousewheel&&this.elements.playlistScroller.unbind().bind("mousewheel", function(d,a){a>0?b.events.scrollbar.up():b.events.scrollbar.down()});this.elements.playlistContainer=this.elements.playlistContainer||c('<div id="player-playlist-container">').addClass("ui-widget-content ui-corner-all");this.elements.playlist=this.elements.playlist||c('<ol id="player-playlist">').addClass("ui-helper-reset");this.elements.scrollbar=this.elements.scrollbar||{bar:c('<div id="player-playlist-scrollbar">').addClass("ui-widget ui-widget-content ui-corner-all").appendTo(this.elements.playlistContainer), up:c('<span id="player-playlist-scrollbar-up">').addClass("ui-icon ui-icon-circle-triangle-n").click(function(){b.events.scrollbar.up()}).appendTo(this.elements.playlistContainer),down:c('<span id="player-playlist-scrollbar-down">').addClass("ui-icon ui-icon-circle-triangle-s").click(function(){b.events.scrollbar.down()}).appendTo(this.elements.playlistContainer),pos:0};this.elements.playlist.empty();this.videoIds=[];c.each(this.options.playlist.videos,function(){b.videoIds.push(this.id);c("<li></li>").data("video", this).append(this.title).addClass("ui-state-default").mouseenter(function(){c(this).addClass("ui-state-hover")}).mouseleave(function(){c(this).removeClass("ui-state-hover")}).click(function(){b.keys.video=c.inArray(c(this).data("video").id,b.videoIds);b.elements.toolbar.buttons.play.element.data("state",0);b.events.updatePlaylist();b.events.play(null,this)}).appendTo(b.elements.playlist)});this.elements.playerVideo.after(this.elements.playlistContainer.append(this.elements.playlistScroller.append(this.elements.playlist))); return this}}})(window.jQuery,window,document);
